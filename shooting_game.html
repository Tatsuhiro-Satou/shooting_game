<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="UTF-8"> 
		<title>Shooting game</title>
		<style>

			.centeredElement {
			  position: fixed; /* or absolute */
			  top: 50%;
			  left: 50%;
			  margin-top: -350px; /* got to be 50% of canvas height */
			  margin-left: -600px; /* got to be 50% of canvas width */
			}

			p { 
				font-family: "Times New Roman";
				border:1px solid #d3d3d3; 
				padding-left: 0;
			   	padding-right: 0;
			   	margin-left: auto;
			   	margin-right: auto; 
				display: block;
			   	width: 800px;
			}

		</style>
	</head>
	<body>
		<canvas id="screen" class="centeredElement" width="1200" height="700"></canvas>
		<p id="debug">...</p>

		<script>
			const CANVAS = document.getElementById('screen');
			const CONTEXT = CANVAS.getContext('2d');
			CONTEXT.font = "30px Arial";
			CONTEXT.fillStyle = "white";
			var NOW, LAST = timestamp();
			var COUNT = 0; // needs better name
			var FPS_COUNT = 0;
			var TOTAL_FRAMES = 0;
			var GLOBAL_TIMER = 0;

			var Keys = {
				UP: false,
				LEFT: false,
				RIGHT: false,
				DOWN: false
			};
			// console.log(); then go to debug in firefox

			document.getElementById("screen").style.backgroundColor = 'rgb(51, 171, 210)';

			window.onkeydown = function(e) {
				//e.preventDefault(); // Prevent the default action of keydown

				if (Boolean(PLAYER.alive)) {
					console.log(e.keyCode);
					if (e.keyCode == 87)
						Keys.UP = true;
					else if (e.keyCode == 65)
						Keys.LEFT = true;
					else if (e.keyCode == 68)
						Keys.RIGHT = true;
					else if (e.keyCode == 83)
						Keys.DOWN = true;
					else if (e.keyCode == 32) // space
						PLAYER.fireMissile();
					else if (e.keyCode == 73) // i 
						alert("Player.x = " + PLAYER.x + ", Player.Y = " + PLAYER.y);
				}
			}
			window.onkeyup = function(e) {
				//e.preventDefault();
				if (Boolean(PLAYER.alive)) {
					if (e.keyCode == 87)
						Keys.UP = false;
					else if (e.keyCode == 65)
						Keys.LEFT = false;
					else if (e.keyCode == 68)
						Keys.RIGHT = false;
					else if (e.keyCode == 83)
						Keys.DOWN = false;
				}
			}

			/*
			   Player has a prototype object from which it inherits stuff
			   When instantiating from this class, a link is created to the original Player constructor class
			   Player is a prototype, the PLAYER var below inherits from the prototypeaPlayer has a prototype object from which it inherits stuffPlayer has a prototype object from which it inherits stuff

		    */
			function Player(initialX, initialY) { // constructor function and class (not object literal) 
				this.image = new Image(); 
				this.image.src = "resources/sprite_jet_player.png";
				this.width = 60;
				this.height = 60;
				this.x = initialX;
				this.y = initialY - this.height;
				this.speed = 5;
				this.score = 0;
				this.alive = 1;
			}

			function Missile(initialX, initialY) {
				this.image = new Image(); 
				this.image.src = "resources/missile.png";
				this.width = 10;
				this.height = 23;
				this.x = initialX;
				this.y = initialY - this.height;
				this.speed = 5;
				this.detonated = 0;
			}

			function EnemyJet(initialX, initialY) {
				this.image = new Image(); 
				this.image.src = "resources/sprite_jet_enemy.png";
				this.width = 60;
				this.height = 60;
				this.x = initialX;
				this.y = initialY - this.height;
				this.speed = 2;
			}

			function Explosion(initialX, initialY) {
				this.image = new Image(); 
				this.image.src = "resources/sprite_explosion.png";
				this.width = 60;
				this.height = 60;
				this.x = initialX;
				this.y = initialY - this.height;
				this.startTime = 0;
			}

			Missile.prototype.draw = function() {
				CONTEXT.drawImage(this.image, this.x, this.y, this.width, this.height);
			};

			EnemyJet.prototype.draw = function() {
				CONTEXT.drawImage(this.image, this.x, this.y, this.width, this.height);
			};

			Player.prototype.draw = function() {
				CONTEXT.drawImage(this.image, this.x, this.y, this.width, this.height);
			};

			Explosion.prototype.draw = function() {
				CONTEXT.drawImage(this.image, this.x, this.y, this.width, this.height);
			};

			Player.prototype.getInfo = function() {
				return "x = " + this.x + ", y = " + this.y;
			};


			var ROCKET_AMMO = 4;
			let alternateMissileWingCount = 0;
			Player.prototype.fireMissile = function() {


				if (ROCKET_AMMO > 0) {
					var MISSILE = new Missile((CANVAS.width / 2), CANVAS.height);
					if (alternateMissileWingCount == 0) {
						MISSILE.x = PLAYER.x;
						alternateMissileWingCount = 1;
					} else if (alternateMissileWingCount == 1) {
						MISSILE.x = PLAYER.x + 50;
						alternateMissileWingCount = 0;
					}

					MISSILE.y = PLAYER.y + 28;
					MISSILES.push(MISSILE);
					ROCKET_AMMO -= 1;
				}
			};

			var PLAYER = new Player((CANVAS.width / 2), CANVAS.height);
			var MISSILES = [];
			var ENEMY_JETS = [];
			var EXPLOSIONS = [];
			var TILE_WATER = new Image();
			TILE_WATER.src = "resources/tile_water.png";

			window.onload = function() {
				init();
			}

			function init() {
				window.requestAnimationFrame(frame);
				CONTEXT.fillText("fps:", 2, 25);
				drawTileArray();
			}

			function drawTileArray() {
				let maxHorizontalTiles = CANVAS.width / 100;
				let maxVerticalTiles = CANVAS.height / 100;
				let maxTiles = maxVerticalTiles * maxHorizontalTiles;

				for (let i = 0; i < maxVerticalTiles; i++) {
					for (let a = 0; a < maxHorizontalTiles; a++) {
						CONTEXT.drawImage(TILE_WATER, a * 100, i * 100, 100, 100);
					}
				}

			}

			function frame() {
				NOW = timestamp();
				var dt  = NOW - LAST;
				LAST = NOW;
				update(dt);
				render(dt);
				window.requestAnimationFrame(frame);
			}

			function timestamp() {
				return window.performance && window.performance.now ? window.performance.now() : new Date().getTime();
			}

			function update(dt) {
				GLOBAL_TIMER += dt;
			 	FPS_COUNT += dt;
				COUNT += dt;

				for (let i = 0; i < MISSILES.length; i++) {
					for (let a = 0; a < ENEMY_JETS.length; a++) {
						/*
						document.getElementById("debug").innerHTML = MISSILES[i].y + ", " + ENEMY_JETS[a].y ;
						alert(MISSILES[i].y + ", " + ENEMY_JETS[a].y);
						*/
						if (collision(MISSILES[i].x, MISSILES[i].y, ENEMY_JETS[a].x, ENEMY_JETS[a].y, MISSILES[i].width, MISSILES[i].height, (ENEMY_JETS[a].width + 5), ENEMY_JETS[a].height)) {
	 						var explosion = new Explosion(ENEMY_JETS[a].x, ENEMY_JETS[a].y);
							explosion.x = ENEMY_JETS[a].x;
							explosion.y = ENEMY_JETS[a].y;
							explosion.startTime = GLOBAL_TIMER;
	 						EXPLOSIONS.push(explosion);
							MISSILES[i].detonated = 1;

							MISSILES.splice(i, 1);
							ENEMY_JETS.splice(a, 1);
							//alert("BOOM");
						}
					}
				}

				for (let i = 0; i < MISSILES.length; i++) {
					if (MISSILES[i].y < 0) {
						MISSILES.splice(i, 1);
					}
				}

				if (Boolean(PLAYER.alive)) {
					for (let i = 0; i < ENEMY_JETS.length; i++) {
						//alert(PLAYER.x + ", " + PLAYER.y + " " + ENEMY_JETS[i].x + " " + ENEMY_JETS[i].y + " " + PLAYER.width + " " + PLAYER.height + " " + ENEMY_JETS[i].width + " " + ENEMY_JETS[i].height);    
						if (collision(PLAYER.x, PLAYER.y, ENEMY_JETS[i].x, ENEMY_JETS[i].y, PLAYER.width, PLAYER.height, ENEMY_JETS[i].width, ENEMY_JETS[i].height)) {
							var explosion = new Explosion(ENEMY_JETS[i].x, ENEMY_JETS[i].y);
							explosion.x = ENEMY_JETS[i].x;
							explosion.y = ENEMY_JETS[i].y;
							explosion.startTime = GLOBAL_TIMER;
							EXPLOSIONS.push(explosion);

							var explosion = new Explosion(PLAYER.x, PLAYER.y);
							explosion.x = PLAYER.x;
							explosion.y = PLAYER.y;
							explosion.startTime = GLOBAL_TIMER;
							EXPLOSIONS.push(explosion);
							ENEMY_JETS.splice(i, 1);
							PLAYER.alive = 0;
						}
					}
				}

				if (ROCKET_AMMO == 0) {
					reload();
				}

				for (let i = 0; i < EXPLOSIONS.length; i++) {
					if ((GLOBAL_TIMER - 1000) > EXPLOSIONS[i].startTime) {
						EXPLOSIONS.splice(i, 1);
					}
				}

				updateEnemies(dt);
				move();
			}

			function collision (entityOneX, entityOneY, entityTwoX, entityTwoY, entityOneWidth, entityOneHeight, entityTwoWidth, entityTwoHeight) {
				if (entityOneX < entityTwoX + entityTwoWidth &&
				   entityOneX + entityOneWidth > entityTwoX &&
				   entityOneY < entityTwoY + entityTwoHeight &&
				   entityOneHeight + entityOneY > entityTwoY) {
					// collision detected!
					return true;
				} else {
					return false;
				}
			}
			/*
			    // my solution
				if ((entityOneX >= entityTwoX) && 
			       ((entityOneX + entityOneWidth) <= (entityTwoX + entityTwoWidth)) &&
     			   (entityOneY <= (entityTwoY + entityTwoHeight)) &&
				   (entityOneY >= entityTwoY)) {
					return true;
				} else {
					return false;
				}

		    */

			var TIMER_RELOAD = 0;
			var TIMER_STARTING_TIME = 0;
			var RELOADING = 0;
			var RELOAD_DURATION = 2000;
			function reload() {
				if (!Boolean(RELOADING)) {
					TIMER_STARTING_TIME = GLOBAL_TIMER;
					//console.log("STARTED: " + TIMER_STARTING_TIME);
					RELOADING = 1;
				}
				//console.log("if " + GLOBAL_TIMER + " > " + (TIMER_STARTING_TIME + 4000));
				//alert("triggered");
				if (GLOBAL_TIMER > (TIMER_STARTING_TIME + RELOAD_DURATION)) {
					ROCKET_AMMO = 4;
					TIMER_STARTING_TIME = 0;
					RELOADING = 0;
				}
			}
			

			function updateEnemies (dt) {
				if (ENEMY_JETS.length != 0) {
					for (let i = 0; i < ENEMY_JETS.length; i++) {
						ENEMY_JETS[i].y += ENEMY_JETS[i].speed;
					}
				}
				if ((GLOBAL_TIMER > 1000) && (ENEMY_JETS.length == 0)) {
					var enemy_jet = new EnemyJet((CANVAS.width / 2), CANVAS.height);
					enemy_jet.x = 600;
					enemy_jet.y = -100;
					ENEMY_JETS.push(enemy_jet);
				}
			}

			var EXPLOSION = new Image();
			EXPLOSION.src = "resources/sprite_explosion.png";
			var TEMP_TOTAL_FRAMERATE = 0;
			function render(dt) {
				if ((COUNT >= 0.06) ) {
					/*
					if (explosion.y != 0) {
						alert("explosion requested at" + explosion.x + ", " + explosion.y);
						//CONTEXT.drawImage(EXPLOSION.image, explosion.x, explosion.y, 20, 20);

					}
					*/
					drawTileArray();
					CONTEXT.fillText("FPS: " + TEMP_TOTAL_FRAMERATE, 2,25);
					if (ROCKET_AMMO != 0) {
						CONTEXT.fillText("ROCKETS: " + ROCKET_AMMO, 2, CANVAS.height - 4);
					} else {
						CONTEXT.fillText("ROCKETS: reloading", 2, CANVAS.height - 4);
					}

					if(FPS_COUNT >= 1000) {
						CONTEXT.fillText("FPS: " + TOTAL_FRAMES, 2,25);
						TEMP_TOTAL_FRAMERATE = TOTAL_FRAMES;
						TOTAL_FRAMES = 0;
						FPS_COUNT = 0;
					}

					if (Boolean(PLAYER.alive)) {
						PLAYER.draw();
					}

					for (let i = 0; i < MISSILES.length; i++) {
						MISSILES[i].draw();
					}
					for (let i = 0; i < ENEMY_JETS.length; i++) {
						ENEMY_JETS[i].draw();
					}
					for (let i = 0; i < EXPLOSIONS.length; i++) {
						EXPLOSIONS[i].draw();
					}
					COUNT = 0;

					if (!Boolean(PLAYER.alive)) {
						let menuSizeX = 500;
						let menuSizeY = 300;
						let menuPosX = ((CANVAS.width / 2) - (menuSizeX / 2));
						let menuPosY = ((CANVAS.height / 2) - (menuSizeY / 2));
						CONTEXT.beginPath();
						CONTEXT.moveTo(menuPosX, menuPosY);
						CONTEXT.lineTo(menuPosX, menuPosY + menuSizeY);
						CONTEXT.moveTo(menuPosX, menuPosY + menuSizeY);
						CONTEXT.lineTo(menuPosX + menuSizeX, menuPosY + menuSizeY);
						CONTEXT.moveTo(menuPosX + menuSizeX, menuPosY + menuSizeY);
						CONTEXT.lineTo(menuPosX + menuSizeX, menuPosY);
						CONTEXT.moveTo(menuPosX + menuSizeX, menuPosY);
						CONTEXT.lineTo(menuPosX, menuPosY);
						CONTEXT.stroke();

						CONTEXT.font = "123px Arial";
						CONTEXT.fillText("You died", menuPosX + 10, menuPosY + (menuSizeY / 2) + 35);
						CONTEXT.font = "30px Arial";
						

						/*
						CONTEXT.fillRect(menuPosX, menuPosY, menuSizeX, menuSizeY);
						CONTEXT.clearRect(menuPosX + 5, menuPosY - 1, menuSizeX - 5, menuSizeY - 5);
						*/
						// size from left
					}

					TOTAL_FRAMES += 1;
				}
				CONTEXT.fillText(Math.round(GLOBAL_TIMER), 1100, 25);
			 // document.getElementById("debug").innerHTML = Math.round(GLOBAL_TIMER);


			}

			var lastKnownPlayerPositionX = 0;
			var lastKnownPlayerPositionY = 0;
			function move() {
				lastKnownPlayerPositionX = PLAYER.x;
				lastKnownPlayerPositionY = PLAYER.y;

				switch (Boolean(Keys)) {
					case Keys.UP && Keys.LEFT: // Northeast 
						if ((isInsideBounds(PLAYER.x, (PLAYER.y - PLAYER.speed))) && (isInsideBounds((PLAYER.x - PLAYER.speed), PLAYER.y))) {
							PLAYER.y -= PLAYER.speed;
							PLAYER.x -= PLAYER.speed;
						}
					break;
					case Keys.UP && Keys.RIGHT: // Northwest
						if ((isInsideBounds(PLAYER.x, (PLAYER.y - PLAYER.speed))) && (isInsideBounds((PLAYER.x + PLAYER.speed), PLAYER.y))) {
							PLAYER.y -= PLAYER.speed;
							PLAYER.x += PLAYER.speed;
						}
					break;
					case Keys.DOWN && Keys.LEFT: // Southeast 
						if ((isInsideBounds(PLAYER.x, (PLAYER.y + PLAYER.speed))) && (isInsideBounds((PLAYER.x - PLAYER.speed), PLAYER.y))) { 
							PLAYER.y += PLAYER.speed;
							PLAYER.x -= PLAYER.speed;
						}
					break;
					case Keys.DOWN && Keys.RIGHT: // Southwest 
						if ((isInsideBounds(PLAYER.x, (PLAYER.y + PLAYER.speed))) && (isInsideBounds((PLAYER.x + PLAYER.speed), PLAYER.y))) { 
							PLAYER.y += PLAYER.speed;
							PLAYER.x += PLAYER.speed;
						}
					break;
					case Keys.UP: // North 
						if (isInsideBounds(PLAYER.x, (PLAYER.y - PLAYER.speed)))
							PLAYER.y -= PLAYER.speed;
					break;
					case Keys.LEFT: // East 
						if (isInsideBounds((PLAYER.x - PLAYER.speed), PLAYER.y))
							PLAYER.x -= PLAYER.speed;
					break;
					case Keys.RIGHT: // West 
						if (isInsideBounds((PLAYER.x + PLAYER.speed), PLAYER.y))
							PLAYER.x += PLAYER.speed;
					break;
					case Keys.DOWN: // South 
						if (isInsideBounds(PLAYER.x, (PLAYER.y + PLAYER.speed)))
							PLAYER.y += PLAYER.speed;
					break;
				}

				for (let i = 0; i < MISSILES.length; i++) {
					MISSILES[i].y -= 10;
				}
			}

			function isInsideBounds(x, y) {
				if (y > (CANVAS.height - PLAYER.height)) { // prevent down
					return 0;
				} else if (x < 0) {
					return 0;
				} else if (x > (CANVAS.width - PLAYER.width)) {
					return 0;
				} else if (y < 0) {
					return 0;
				} else {
					return 1;
				}
			}

		</script>
	</body> 
</html>
